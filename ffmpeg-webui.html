<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFmpeg Web-UI - MacMilling Computer Software Entertainment Technologies</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --color-primary: #21808d;
            --color-primary-hover: #1d7480;
            --color-primary-active: #1a6873;
            --color-bg-primary: #fcfcf9;
            --color-bg-secondary: #fffffe;
            --color-text-primary: #134252;
            --color-text-secondary: #626c71;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-surface: #ffffff;
            --color-success: #21808d;
            --color-error: #c0152f;
            --color-warning: #a84b2f;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-bg-primary: #1f2121;
                --color-bg-secondary: #262828;
                --color-text-primary: #f5f5f5;
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-border: rgba(119, 124, 124, 0.3);
                --color-surface: #262828;
                --color-primary: #32b8c6;
                --color-primary-hover: #2da6b2;
                --color-primary-active: #2996a1;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background-color: var(--color-bg-secondary);
            border-right: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .logo-section {
            padding: 20px;
            border-bottom: 1px solid var(--color-border);
        }

        .logo-section img {
            width: 100%;
            max-width: 200px;
            height: auto;
        }

        .app-title {
            margin-top: 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .vendor-info {
            margin-top: 4px;
            font-size: 11px;
            color: var(--color-text-secondary);
            line-height: 1.4;
        }

        /* Tree View Navigation */
        .nav-tree {
            padding: 16px 0;
        }

        .tree-section-title {
            padding: 8px 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text-secondary);
            letter-spacing: 0.5px;
        }

        .tree-item {
            list-style: none;
        }

        .tree-item-content {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--color-text-primary);
            text-decoration: none;
        }

        .tree-item-content:hover {
            background-color: rgba(var(--color-primary), 0.08);
        }

        .tree-item-content.active {
            background-color: rgba(33, 128, 141, 0.12);
            color: var(--color-primary);
            font-weight: 500;
        }

        .tree-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tree-label {
            flex: 1;
            font-size: 14px;
        }

        .tree-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            background-color: var(--color-primary);
            color: white;
        }

        .tree-badge.soon {
            background-color: var(--color-text-secondary);
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 20px 32px;
            border-bottom: 1px solid var(--color-border);
            background-color: var(--color-bg-secondary);
        }

        .content-header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .content-header p {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        /* Panel Styles */
        .panel {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--color-text-primary);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1);
        }

        select.form-control {
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* File List */
        .file-list {
            border: 1px solid var(--color-border);
            border-radius: 8px;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--color-bg-primary);
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--color-border);
            transition: background-color 0.2s;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background-color: rgba(33, 128, 141, 0.05);
        }

        .file-icon {
            width: 40px;
            height: 40px;
            margin-right: 12px;
            background-color: var(--color-primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .file-size {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .file-remove {
            padding: 6px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            background: transparent;
            color: var(--color-error);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .file-remove:hover {
            background-color: rgba(192, 21, 47, 0.1);
            border-color: var(--color-error);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: var(--color-text-secondary);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }

        .btn-primary:active {
            background-color: var(--color-primary-active);
        }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }

        .btn-secondary:hover {
            background-color: rgba(33, 128, 141, 0.05);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Preset Grid */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .preset-card {
            padding: 16px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--color-bg-primary);
        }

        .preset-card:hover {
            border-color: var(--color-primary);
            background-color: var(--color-surface);
        }

        .preset-card.selected {
            border-color: var(--color-primary);
            background-color: rgba(33, 128, 141, 0.08);
        }

        .preset-card-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--color-text-primary);
        }

        .preset-card-desc {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        /* Progress Section */
        .progress-section {
            display: none;
            margin-top: 24px;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: rgba(33, 128, 141, 0.15);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--color-primary);
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 14px;
            color: var(--color-text-secondary);
            text-align: center;
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            padding: 16px;
            background-color: rgba(33, 128, 141, 0.08);
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 40vh;
            }

            .content-body {
                padding: 20px;
            }

            .preset-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Hidden file input */
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="logo-section">
            <img src="https://github.com/MacMillingComputerSoftwareEntertainment/.github/blob/0ed7278da9cc4fdf982616c4f17e369c75f34aea/profile/docs/logo_macmilling.png?raw=true" alt="MacMilling Logo">
            <h2 class="app-title">FFmpeg Web-UI</h2>
            <p class="vendor-info">MacMilling Computer Software Entertainment Technologies Lit.</p>
        </div>

        <nav class="nav-tree">
            <div class="tree-section-title">Modules</div>
            <ul>
                <li class="tree-item">
                    <a href="#frames-extract" class="tree-item-content active" id="navFramesExtract">
                        <span class="tree-icon">üé¨</span>
                        <span class="tree-label">Frames Extract</span>
                        <span class="tree-badge">Active</span>
                    </a>
                </li>
                <li class="tree-item">
                    <a href="#" class="tree-item-content">
                        <span class="tree-icon">‚úÇÔ∏è</span>
                        <span class="tree-label">Video Trimmer</span>
                        <span class="tree-badge soon">Soon</span>
                    </a>
                </li>
                <li class="tree-item">
                    <a href="#" class="tree-item-content">
                        <span class="tree-icon">üîÑ</span>
                        <span class="tree-label">Format Converter</span>
                        <span class="tree-badge soon">Soon</span>
                    </a>
                </li>
                <li class="tree-item">
                    <a href="#" class="tree-item-content">
                        <span class="tree-icon">üîä</span>
                        <span class="tree-label">Audio Extractor</span>
                        <span class="tree-badge soon">Soon</span>
                    </a>
                </li>
                <li class="tree-item">
                    <a href="#" class="tree-item-content">
                        <span class="tree-icon">üìä</span>
                        <span class="tree-label">Video Analyzer</span>
                        <span class="tree-badge soon">Soon</span>
                    </a>
                </li>
            </ul>

            <div class="tree-section-title" style="margin-top: 24px;">Settings</div>
            <ul>
                <li class="tree-item">
                    <a href="#" class="tree-item-content">
                        <span class="tree-icon">‚öôÔ∏è</span>
                        <span class="tree-label">Preferences</span>
                    </a>
                </li>
                <li class="tree-item">
                    <a href="#" class="tree-item-content">
                        <span class="tree-icon">‚ÑπÔ∏è</span>
                        <span class="tree-label">About</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <h1>Frames Extract</h1>
            <p>Extract video frames from your video files with customizable intervals and settings</p>
        </header>

        <div class="content-body">
            <!-- Video Files Section -->
            <div class="panel">
                <h2 class="panel-title">
                    üìÅ Video Files
                </h2>
                
                <input type="file" id="fileInput" accept="video/*" multiple>
                <button class="btn btn-secondary" id="addFilesBtn">
                    <span>‚ûï</span>
                    Add Video Files
                </button>

                <div class="file-list" id="fileList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üé•</div>
                        <p>No video files added yet</p>
                        <p style="font-size: 12px; margin-top: 4px;">Click "Add Video Files" to get started</p>
                    </div>
                </div>
            </div>

            <!-- Extraction Settings -->
            <div class="panel">
                <h2 class="panel-title">
                    ‚öôÔ∏è Extraction Settings
                </h2>

                <div class="form-group">
                    <label class="form-label">Extraction Mode</label>
                    <div class="preset-grid" id="presetGrid">
                        <div class="preset-card" data-mode="all">
                            <div class="preset-card-title">Extract All Frames</div>
                            <div class="preset-card-desc">Every single frame</div>
                        </div>
                        <div class="preset-card" data-mode="fps-1">
                            <div class="preset-card-title">1 Frame/Second</div>
                            <div class="preset-card-desc">One frame every second</div>
                        </div>
                        <div class="preset-card selected" data-mode="interval-30">
                            <div class="preset-card-title">Every 30 Seconds</div>
                            <div class="preset-card-desc">Time-based interval</div>
                        </div>
                        <div class="preset-card" data-mode="interval-60">
                            <div class="preset-card-title">Every 1 Minute</div>
                            <div class="preset-card-desc">60 second interval</div>
                        </div>
                        <div class="preset-card" data-mode="total-25">
                            <div class="preset-card-title">25 Frames Total</div>
                            <div class="preset-card-desc">Evenly distributed</div>
                        </div>
                        <div class="preset-card" data-mode="custom">
                            <div class="preset-card-title">Custom Settings</div>
                            <div class="preset-card-desc">Define your own</div>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="customSettingsGroup" style="display: none;">
                    <label class="form-label">Custom Interval</label>
                    <select class="form-control" id="customIntervalType">
                        <option value="seconds">Interval (Seconds)</option>
                        <option value="frames">Frame Count</option>
                        <option value="total">Total Frames</option>
                    </select>
                </div>

                <div class="form-group" id="customValueGroup" style="display: none; margin-top: 12px;">
                    <label class="form-label" id="customValueLabel">Interval Value</label>
                    <input type="number" class="form-control" id="customValue" min="1" value="30">
                </div>

                <div class="form-group">
                    <label class="form-label">Output Format</label>
                    <select class="form-control" id="outputFormat">
                        <option value="png">PNG (Lossless)</option>
                        <option value="jpg">JPEG (Compressed)</option>
                        <option value="webp">WebP (Modern)</option>
                        <option value="bmp">BMP (Uncompressed)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Image Quality (for JPEG/WebP)</label>
                    <input type="range" class="form-control" id="imageQuality" min="1" max="31" value="2" style="cursor: pointer;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--color-text-secondary); margin-top: 4px;">
                        <span>High (1)</span>
                        <span id="qualityValue">2</span>
                        <span>Low (31)</span>
                    </div>
                </div>
            </div>

            <!-- Output Settings -->
            <div class="panel">
                <h2 class="panel-title">
                    üíæ Output Settings
                </h2>

                <div class="form-group">
                    <label class="form-label">Destination Folder Name</label>
                    <input type="text" class="form-control" id="destinationFolder" value="extracted_frames" placeholder="Enter folder name">
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="createSubfolders" checked>
                        <label for="createSubfolders" style="cursor: pointer;">Create subfolders for each video file</label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Frame Naming Pattern</label>
                    <select class="form-control" id="namingPattern">
                        <option value="frame_%04d">frame_0001, frame_0002...</option>
                        <option value="%s_frame_%04d">videoname_frame_0001...</option>
                        <option value="%s_%04d">videoname_0001, videoname_0002...</option>
                        <option value="timestamp_%04d">timestamp_0001...</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" id="startExtractionBtn" disabled>
                        <span>üöÄ</span>
                        Start Extraction
                    </button>
                    <button class="btn btn-secondary" id="clearAllBtn">
                        <span>üóëÔ∏è</span>
                        Clear All
                    </button>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="panel progress-section" id="progressSection">
                <h2 class="panel-title">
                    ‚è≥ Extraction Progress
                </h2>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <p class="progress-text" id="progressText">Initializing extraction...</p>
            </div>

            <!-- Results Section -->
            <div class="panel results-section" id="resultsSection">
                <h2 class="panel-title">
                    ‚úÖ Extraction Complete
                </h2>
                <p style="color: var(--color-text-secondary); margin-bottom: 16px;">Frame extraction completed successfully!</p>
                
                <div class="result-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalFilesProcessed">0</div>
                        <div class="stat-label">Files Processed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalFramesExtracted">0</div>
                        <div class="stat-label">Frames Extracted</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalDuration">0s</div>
                        <div class="stat-label">Total Time</div>
                    </div>
                </div>

                <div id="zipDownloadSection" style="margin-top: 24px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">Download Options</h3>
                    
                    <div id="individualZipsContainer" style="margin-bottom: 16px;">
                        <!-- Individual ZIP buttons will be inserted here -->
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" id="downloadAllZipBtn">
                            <span>üì¶</span>
                            Download All as Single ZIP
                        </button>
                        <button class="btn btn-secondary" id="newExtractionBtn">
                            <span>üîÑ</span>
                            New Extraction
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // State management
        const state = {
            files: [],
            selectedMode: 'interval-30',
            isProcessing: false,
            customSettings: {
                type: 'seconds',
                value: 30
            },
            outputFormat: 'png',
            quality: 2,
            destinationFolder: 'extracted_frames',
            createSubfolders: true,
            namingPattern: 'frame_%04d',
            extractedFrames: {} // Store extracted frames by video file ID
        };

        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const addFilesBtn = document.getElementById('addFilesBtn');
        const fileList = document.getElementById('fileList');
        const presetCards = document.querySelectorAll('.preset-card');
        const customSettingsGroup = document.getElementById('customSettingsGroup');
        const customValueGroup = document.getElementById('customValueGroup');
        const customIntervalType = document.getElementById('customIntervalType');
        const customValue = document.getElementById('customValue');
        const customValueLabel = document.getElementById('customValueLabel');
        const outputFormat = document.getElementById('outputFormat');
        const imageQuality = document.getElementById('imageQuality');
        const qualityValue = document.getElementById('qualityValue');
        const destinationFolder = document.getElementById('destinationFolder');
        const createSubfolders = document.getElementById('createSubfolders');
        const namingPattern = document.getElementById('namingPattern');
        const startExtractionBtn = document.getElementById('startExtractionBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const resultsSection = document.getElementById('resultsSection');
        const totalFilesProcessed = document.getElementById('totalFilesProcessed');
        const totalFramesExtracted = document.getElementById('totalFramesExtracted');
        const totalDuration = document.getElementById('totalDuration');
        const newExtractionBtn = document.getElementById('newExtractionBtn');

        // Add files
        addFilesBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.type.startsWith('video/')) {
                    state.files.push({
                        id: Date.now() + Math.random(),
                        file: file,
                        name: file.name,
                        size: formatFileSize(file.size)
                    });
                }
            });
            renderFileList();
            updateStartButton();
            fileInput.value = '';
        });

        // Render file list
        function renderFileList() {
            if (state.files.length === 0) {
                fileList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üé•</div>
                        <p>No video files added yet</p>
                        <p style="font-size: 12px; margin-top: 4px;">Click "Add Video Files" to get started</p>
                    </div>
                `;
                return;
            }

            fileList.innerHTML = state.files.map(file => `
                <div class="file-item">
                    <div class="file-icon">üé¨</div>
                    <div class="file-info">
                        <div class="file-name">${escapeHtml(file.name)}</div>
                        <div class="file-size">${file.size}</div>
                    </div>
                    <button class="file-remove" onclick="removeFile('${file.id}')">Remove</button>
                </div>
            `).join('');
        }

        // Remove file
        window.removeFile = function(fileId) {
            state.files = state.files.filter(f => f.id !== parseFloat(fileId));
            renderFileList();
            updateStartButton();
        };

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Preset selection
        presetCards.forEach(card => {
            card.addEventListener('click', () => {
                presetCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                state.selectedMode = card.dataset.mode;

                if (state.selectedMode === 'custom') {
                    customSettingsGroup.style.display = 'block';
                    customValueGroup.style.display = 'block';
                } else {
                    customSettingsGroup.style.display = 'none';
                    customValueGroup.style.display = 'none';
                }
            });
        });

        // Custom settings
        customIntervalType.addEventListener('change', (e) => {
            state.customSettings.type = e.target.value;
            switch(e.target.value) {
                case 'seconds':
                    customValueLabel.textContent = 'Interval (Seconds)';
                    customValue.placeholder = 'e.g., 30';
                    break;
                case 'frames':
                    customValueLabel.textContent = 'Every N Frames';
                    customValue.placeholder = 'e.g., 10';
                    break;
                case 'total':
                    customValueLabel.textContent = 'Total Frame Count';
                    customValue.placeholder = 'e.g., 25';
                    break;
            }
        });

        customValue.addEventListener('input', (e) => {
            state.customSettings.value = parseInt(e.target.value) || 1;
        });

        // Output format
        outputFormat.addEventListener('change', (e) => {
            state.outputFormat = e.target.value;
        });

        // Image quality
        imageQuality.addEventListener('input', (e) => {
            state.quality = parseInt(e.target.value);
            qualityValue.textContent = e.target.value;
        });

        // Destination folder
        destinationFolder.addEventListener('input', (e) => {
            state.destinationFolder = e.target.value;
        });

        // Create subfolders
        createSubfolders.addEventListener('change', (e) => {
            state.createSubfolders = e.target.checked;
        });

        // Naming pattern
        namingPattern.addEventListener('change', (e) => {
            state.namingPattern = e.target.value;
        });

        // Update start button
        function updateStartButton() {
            startExtractionBtn.disabled = state.files.length === 0;
        }

        // Start extraction
        startExtractionBtn.addEventListener('click', async () => {
            if (state.isProcessing) return;
            await startRealExtraction();
        });

        // Real extraction process with video processing
        async function startRealExtraction() {
            state.isProcessing = true;
            startExtractionBtn.disabled = true;
            progressSection.classList.add('active');
            resultsSection.classList.remove('active');
            state.extractedFrames = {}; // Reset extracted frames
            
            const fileCount = state.files.length;
            let currentFile = 0;
            let totalFramesExtracted = 0;
            const startTime = Date.now();

            // Process each video file
            for (const videoFile of state.files) {
                currentFile++;
                progressText.textContent = `Processing ${videoFile.name} (${currentFile}/${fileCount})...`;
                
                try {
                    const frames = await extractFramesFromVideo(videoFile, currentFile, fileCount);
                    totalFramesExtracted += frames;
                    
                    const progress = (currentFile / fileCount) * 100;
                    progressBar.style.width = progress + '%';
                } catch (error) {
                    console.error(`Error processing ${videoFile.name}:`, error);
                    progressText.textContent = `Error processing ${videoFile.name}. Continuing...`;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            const duration = ((Date.now() - startTime) / 1000).toFixed(1);
            state.isProcessing = false;
            showResults(fileCount, totalFramesExtracted, duration);
        }

        // Extract frames from a single video using canvas
        async function extractFramesFromVideo(videoFile, currentIndex, totalFiles) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                let framesExtracted = 0;
                const frames = []; // Store frames temporarily

                video.preload = 'metadata';
                video.muted = true;

                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    const duration = video.duration;
                    const framesToExtract = calculateFramesToExtract(duration);
                    
                    extractNextFrame(0);

                    function extractNextFrame(index) {
                        if (index >= framesToExtract.length) {
                            // Store frames for this video file
                            state.extractedFrames[videoFile.id] = {
                                videoName: videoFile.name,
                                frames: frames
                            };
                            resolve(framesExtracted);
                            return;
                        }

                        const time = framesToExtract[index];
                        video.currentTime = time;

                        video.onseeked = () => {
                            try {
                                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                                
                                // Convert canvas to blob and store temporarily
                                const format = state.outputFormat;
                                const quality = format === 'jpg' || format === 'webp' ? (1 - (state.quality - 1) / 30) : 1;
                                const mimeType = getMimeType(format);

                                canvas.toBlob((blob) => {
                                    if (blob) {
                                        const fileName = generateFileName(videoFile.name, index + 1, format);
                                        
                                        // Store frame data
                                        frames.push({
                                            blob: blob,
                                            fileName: fileName
                                        });
                                        
                                        framesExtracted++;
                                        
                                        // Update progress
                                        const fileProgress = (index / framesToExtract.length) * 100;
                                        const totalProgress = ((currentIndex - 1) / totalFiles * 100) + (fileProgress / totalFiles);
                                        progressBar.style.width = totalProgress + '%';
                                        progressText.textContent = `Processing ${videoFile.name} - Frame ${index + 1}/${framesToExtract.length}`;
                                    }
                                    
                                    // Small delay between frames to prevent browser freezing
                                    setTimeout(() => extractNextFrame(index + 1), 50);
                                }, mimeType, quality);
                            } catch (error) {
                                console.error('Error extracting frame:', error);
                                setTimeout(() => extractNextFrame(index + 1), 50);
                            }
                        };

                        video.onerror = () => {
                            console.error('Error seeking video');
                            setTimeout(() => extractNextFrame(index + 1), 50);
                        };
                    }
                };

                video.onerror = () => {
                    reject(new Error('Failed to load video'));
                };

                video.src = URL.createObjectURL(videoFile.file);
            });
        }

        // Calculate which frames/times to extract based on selected mode
        function calculateFramesToExtract(videoDuration) {
            const times = [];
            
            switch(state.selectedMode) {
                case 'all':
                    // Extract at 1 FPS (assuming 30fps video, this gives every 30th frame)
                    const fps = 1;
                    for (let t = 0; t < videoDuration; t += (1/fps)) {
                        times.push(t);
                    }
                    break;
                
                case 'fps-1':
                    // 1 frame per second
                    for (let t = 0; t < videoDuration; t += 1) {
                        times.push(t);
                    }
                    break;
                
                case 'interval-30':
                    // Every 30 seconds
                    for (let t = 0; t < videoDuration; t += 30) {
                        times.push(t);
                    }
                    break;
                
                case 'interval-60':
                    // Every 60 seconds
                    for (let t = 0; t < videoDuration; t += 60) {
                        times.push(t);
                    }
                    break;
                
                case 'total-25':
                    // 25 frames evenly distributed
                    const totalFrames = 25;
                    for (let i = 0; i < totalFrames; i++) {
                        times.push((videoDuration / totalFrames) * i);
                    }
                    break;
                
                case 'custom':
                    if (state.customSettings.type === 'seconds') {
                        // Every N seconds
                        for (let t = 0; t < videoDuration; t += state.customSettings.value) {
                            times.push(t);
                        }
                    } else if (state.customSettings.type === 'frames') {
                        // Every N frames (assuming 30fps)
                        const frameInterval = state.customSettings.value / 30;
                        for (let t = 0; t < videoDuration; t += frameInterval) {
                            times.push(t);
                        }
                    } else if (state.customSettings.type === 'total') {
                        // Total N frames
                        const total = state.customSettings.value;
                        for (let i = 0; i < total; i++) {
                            times.push((videoDuration / total) * i);
                        }
                    }
                    break;
            }
            
            // Ensure we don't exceed video duration
            return times.filter(t => t < videoDuration);
        }

        // Get MIME type for canvas export
        function getMimeType(format) {
            const mimeTypes = {
                'png': 'image/png',
                'jpg': 'image/jpeg',
                'webp': 'image/webp',
                'bmp': 'image/bmp'
            };
            return mimeTypes[format] || 'image/png';
        }

        // Generate file name based on naming pattern
        function generateFileName(videoName, frameNumber, format) {
            const baseName = videoName.replace(/\.[^/.]+$/, ''); // Remove extension
            const paddedNumber = String(frameNumber).padStart(4, '0');
            
            let fileName = '';
            switch(state.namingPattern) {
                case 'frame_%04d':
                    fileName = `frame_${paddedNumber}`;
                    break;
                case '%s_frame_%04d':
                    fileName = `${baseName}_frame_${paddedNumber}`;
                    break;
                case '%s_%04d':
                    fileName = `${baseName}_${paddedNumber}`;
                    break;
                case 'timestamp_%04d':
                    fileName = `timestamp_${paddedNumber}`;
                    break;
                default:
                    fileName = `frame_${paddedNumber}`;
            }
            
            return `${fileName}.${format}`;
        }

        // Create ZIP file for a single video's frames
        async function createZipForVideo(videoId) {
            const videoData = state.extractedFrames[videoId];
            if (!videoData) return;

            const zip = new JSZip();
            const baseName = videoData.videoName.replace(/\.[^/.]+$/, '');
            
            // Create folder structure
            const folderName = state.createSubfolders ? baseName : '';
            const folder = folderName ? zip.folder(folderName) : zip;

            // Add all frames to ZIP
            for (const frame of videoData.frames) {
                folder.file(frame.fileName, frame.blob);
            }

            // Generate and download ZIP
            progressText.textContent = `Creating ZIP archive for ${videoData.videoName}...`;
            const content = await zip.generateAsync({ type: 'blob' });
            
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${baseName}_frames.zip`;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        // Create single ZIP with all extracted frames
        async function createCombinedZip() {
            const zip = new JSZip();
            const rootFolder = zip.folder(state.destinationFolder);

            progressSection.classList.add('active');
            progressText.textContent = 'Creating combined ZIP archive...';
            progressBar.style.width = '0%';

            let processedVideos = 0;
            const totalVideos = Object.keys(state.extractedFrames).length;

            // Add frames from each video
            for (const [videoId, videoData] of Object.entries(state.extractedFrames)) {
                const baseName = videoData.videoName.replace(/\.[^/.]+$/, '');
                const videoFolder = state.createSubfolders ? rootFolder.folder(baseName) : rootFolder;

                for (const frame of videoData.frames) {
                    videoFolder.file(frame.fileName, frame.blob);
                }

                processedVideos++;
                const progress = (processedVideos / totalVideos) * 100;
                progressBar.style.width = progress + '%';
                progressText.textContent = `Adding ${videoData.videoName} to archive... (${processedVideos}/${totalVideos})`;
                
                // Allow UI to update
                await new Promise(resolve => setTimeout(resolve, 10));
            }

            progressText.textContent = 'Generating ZIP file...';
            const content = await zip.generateAsync({ 
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            });

            progressSection.classList.remove('active');
            progressBar.style.width = '0%';

            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.destinationFolder}.zip`;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        // Show results and create ZIP download buttons
        function showResults(filesProcessed, framesExtracted, duration) {
            progressSection.classList.remove('active');
            resultsSection.classList.add('active');
            startExtractionBtn.disabled = false;
            
            totalFilesProcessed.textContent = filesProcessed;
            totalFramesExtracted.textContent = framesExtracted;
            totalDuration.textContent = duration + 's';

            // Create individual ZIP download buttons
            const individualZipsContainer = document.getElementById('individualZipsContainer');
            individualZipsContainer.innerHTML = '<p style="font-size: 14px; font-weight: 500; margin-bottom: 12px;">Download individual ZIP files:</p>';
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'grid';
            buttonContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(250px, 1fr))';
            buttonContainer.style.gap = '12px';

            for (const [videoId, videoData] of Object.entries(state.extractedFrames)) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-secondary';
                btn.innerHTML = `<span>üì¶</span> ${escapeHtml(videoData.videoName)} (${videoData.frames.length} frames)`;
                btn.onclick = () => createZipForVideo(videoId);
                buttonContainer.appendChild(btn);
            }

            individualZipsContainer.appendChild(buttonContainer);

            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        // Download all as single ZIP
        const downloadAllZipBtn = document.getElementById('downloadAllZipBtn');
        downloadAllZipBtn.addEventListener('click', async () => {
            await createCombinedZip();
        });

        // Clear all
        clearAllBtn.addEventListener('click', () => {
            if (state.files.length > 0) {
                if (confirm('Are you sure you want to clear all video files?')) {
                    state.files = [];
                    renderFileList();
                    updateStartButton();
                }
            }
        });

        // New extraction
        newExtractionBtn.addEventListener('click', () => {
            resultsSection.classList.remove('active');
            progressSection.classList.remove('active');
            progressBar.style.width = '0%';
            progressText.textContent = 'Initializing extraction...';
            state.files = [];
            state.extractedFrames = {};
            renderFileList();
            updateStartButton();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Initialize
        renderFileList();
        updateStartButton();
    </script>
</body>
</html>

